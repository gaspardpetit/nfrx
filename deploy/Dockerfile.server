FROM --platform=$BUILDPLATFORM golang:1.24 AS build
WORKDIR /src
COPY . .
RUN go work sync && \
    (cd nfrx-server && go mod download) && \
    (cd nfrx-plugins-llm && go mod download) && \
    (cd nfrx-plugins-mcp && go mod download) && \
    (cd nfrx-sdk && go mod download)
ARG TARGETOS TARGETARCH VERSION=dev GIT_SHA=unknown BUILD_DATE=unknown
RUN CGO_ENABLED=0 GOOS=$TARGETOS GOARCH=$TARGETARCH \
    go build -ldflags "-s -w -X main.version=${VERSION} -X main.buildSHA=${GIT_SHA} -X main.buildDate=${BUILD_DATE}" \
      -o /out/nfrx ./nfrx-server/cmd/nfrx

FROM gcr.io/distroless/base-debian12
COPY --from=build /out/nfrx /nfrx
EXPOSE 8080
ENTRYPOINT ["/nfrx"]
